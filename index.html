<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>HealthyScan – Demo</title>
<style>
  :root{--bg:#f3f5f8;--card:#fff;--ink:#0f172a;--muted:#6b7280;--ok:#10b981;--warn:#f59e0b;--bad:#ef4444;--bd:#e5e7eb}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.4 system-ui,-apple-system,Segoe UI,Inter,Roboto}
  .wrap{max-width:980px;margin:0 auto;padding:20px;display:grid;gap:16px}
  .grid{display:grid;gap:16px}
  @media(min-width:900px){.grid{grid-template-columns:1.1fr .9fr}}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:16px;box-shadow:0 4px 18px rgba(15,23,42,.06)}
  .card .hd{padding:14px 16px;border-bottom:1px solid var(--bd);font-weight:700}
  .card .bd{padding:16px}
  video{width:100%;display:block;border-radius:12px;background:#000}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .btn{appearance:none;border:1px solid var(--bd);border-radius:10px;padding:12px 14px;background:#fff;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--ok);border-color:var(--ok);color:#052e1a}
  .muted{color:var(--muted)} .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{border:1px solid var(--bd);padding:6px 10px;border-radius:999px; font-size:12px;background:#fff}
  .switch{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--bd);border-radius:10px;padding:10px 12px}
  .switch input{width:38px;height:22px;appearance:none;background:#e5e7eb;border-radius:999px;position:relative;outline:none;cursor:pointer}
  .switch input:checked{background:var(--ok)} .switch input::after{content:"";position:absolute;top:3px;left:3px;width:16px;height:16px;background:#fff;border-radius:50%;transition:.2s}
  .switch input:checked::after{left:19px}
  .list{margin:8px 0 0 18px;color:var(--muted)}
  .score{font-size:36px;font-weight:800;margin:6px 0}
  progress{width:100%;height:10px;appearance:none} progress::-webkit-progress-bar{background:#eef2f7;border-radius:8px}
  progress::-webkit-progress-value{background:linear-gradient(90deg,#34d399,#22c55e);border-radius:8px}
  input[type=text]{width:100%;border:1px solid var(--bd);border-radius:10px;padding:10px}
</style>
</head>
<body>
<div class="wrap">
  <div class="grid">
    <!-- Live Camera -->
    <section class="card">
      <div class="hd">Live Camera</div>
      <div class="bd">
        <video id="cam" autoplay playsinline muted></video>
        <div class="row">
          <button class="btn" id="startBtn">Start/Wechsel Kamera</button>
          <button class="btn primary" id="scanBtn">📷 Jetzt analysieren</button>
        </div>
        <div class="muted" id="hint" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- Panel rechts -->
    <section class="card">
      <div class="hd">Scan Settings</div>
      <div class="bd" style="display:grid;gap:12px">
        <label class="switch"><span>Auto‑Bewertung in Echtzeit</span><input id="autoToggle" type="checkbox"></label>
        <label class="switch"><span>Produkt‑Tracking (nur UI)</span><input id="trackToggle" type="checkbox"></label>
        <label class="switch"><span>Voice‑Feedback (Deutsch)</span><input id="voiceToggle" type="checkbox"></label>

        <div>
          <div class="muted">Produkt‑Hinweis (optional, z. B. „granola bar, wenig Zucker“)</div>
          <input id="hintInput" type="text" placeholder="Produktname oder kurze Beschreibung">
        </div>

        <div class="muted">Tipps:</div>
        <ul class="list">
          <li>Gute Beleuchtung, ruhig halten</li>
          <li>Auf Produktnamen / Nährwerte fokussieren</li>
          <li>Label möglichst frontal</li>
        </ul>

        <div class="chips">
          <span class="chip" id="modeChip">Unbekannt</span>
          <span class="chip" id="rtChip">Manuell</span>
          <span class="chip" id="freqChip">Update: 900 ms</span>
        </div>
      </div>
    </section>
  </div>

  <!-- Ergebnisse -->
  <section class="card">
    <div class="hd">Ergebnis</div>
    <div class="bd" style="display:grid;gap:10px">
      <div class="score" id="score">–</div>
      <progress id="bar" max="10" value="0"></progress>
      <div id="summary" class="muted">Noch keine Analyse ausgeführt.</div>
      <div id="pros"></div>
      <div id="cons"></div>
      <div id="err" style="color:#b91c1c;font-weight:600"></div>
    </div>
  </section>
</div>

<script>
let currentStream=null, facingEnv=true, loopId=null;
const v=()=>document.getElementById('cam');
const qs=id=>document.getElementById(id);
const scoreEl=qs('score'), bar=qs('bar'), summary=qs('summary'), errEl=qs('err');
const pros=qs('pros'), cons=qs('cons'), hintEl=qs('hint');
const autoT=qs('autoToggle'), voiceT=qs('voiceToggle'), modeChip=qs('modeChip'), rtChip=qs('rtChip');

async function startCamera() {
  try{
    if(currentStream){currentStream.getTracks().forEach(t=>t.stop());}
    const constraints = { video: { facingMode: { ideal: facingEnv ? "environment" : "user" } } };
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    currentStream=stream; v().srcObject=stream;
    await v().play();
    await new Promise(r=>{
      if(v().videoWidth) return r();
      v().addEventListener('loadedmetadata', r, {once:true});
    });
    hintEl.textContent = `Kamera aktiv (${facingEnv?"Rück":"Front"}) • ${v().videoWidth}×${v().videoHeight}`;
  }catch(e){ errEl.textContent="Kamera‑Fehler: "+e.message; }
}

function speak(text){
  if(!voiceT.checked) return;
  try{
    const u=new SpeechSynthesisUtterance(text);
    u.lang="de-DE"; u.rate=1; u.pitch=1; speechSynthesis.cancel(); speechSynthesis.speak(u);
  }catch{}
}

function renderResult(r){
  errEl.textContent="";
  const sc = Number(r.score ?? 0);
  scoreEl.textContent = `${isNaN(sc)?"–":sc}/10`;
  bar.value = isNaN(sc)?0:sc;
  const good = sc>=7 ? "✅ eher gesund" : sc>=4 ? "⚠️ mittelmäßig" : "🚫 eher ungesund";
  summary.textContent = r.summary || r.details || good;

  const list = (title,arr,color)=>`<div><div style="font-weight:700">${title}</div><ul class="list" style="color:${color}">${(arr||[]).map(x=>`<li>${x}</li>`).join("")}</ul></div>`;
  pros.innerHTML = list("Vorteile", r.pros, "#16a34a");
  cons.innerHTML = list("Nachteile", r.cons, "#b91c1c");

  speak(`Gesundheitswertung ${sc} von 10. ${r.summary || ""}`);
}

async function captureBase64(){
  if(!v().videoWidth||!v().videoHeight) return null;
  const c=document.createElement('canvas'); c.width=v().videoWidth; c.height=v().videoHeight;
  c.getContext('2d').drawImage(v(),0,0,c.width,c.height);
  return c.toDataURL('image/jpeg',0.85).split(',')[1];
}

async function analyzeOnce(){
  errEl.textContent=""; summary.textContent="Analysiere…"; modeChip.textContent="Real‑time";
  const b64 = await captureBase64();
  if(!b64){ errEl.textContent="Kein Kamerabild verfügbar."; return; }

  try{
    const res = await fetch("/api/analyse",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({
      imageBase64:b64, hint: qs('hintInput').value?.trim() || ""
    })});
    const data = await res.json();
    if(!res.ok){ throw new Error(data.error || "API‑Fehler"); }
    renderResult(data);
  }catch(e){
    errEl.textContent = e.message;
  }
}

function toggleLoop(){
  if(autoT.checked){
    rtChip.textContent="Echtzeit";
    loopId = setInterval(analyzeOnce, 900);
  }else{
    rtChip.textContent="Manuell";
    clearInterval(loopId); loopId=null;
  }
}

qs('scanBtn').addEventListener('click', analyzeOnce);
qs('startBtn').addEventListener('click', ()=>{facingEnv=!facingEnv; startCamera();});
autoT.addEventListener('change', toggleLoop);

startCamera();
</script>
</body>
</html>
